<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CITRO ‚Äî Sistema de Tr√°mites v3</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
:root{
  --navy:#0D1F3C; --navy2:#16325A; --teal:#0A7A6E; --teal2:#0DB8A8;
  --amber:#E8920A; --amber2:#FFC542; --red:#C0392B; --green:#1A7A4A;
  --blue:#1B5FA8; --purple:#5B2F8A; --orange:#B85C0A;
  --white:#fff; --surf:#F2F5FA; --surf2:#E8EDF5; --border:#C8D4E8;
  --text:#162040; --muted:#5A6880; --light:#8A9AB8;
  --r:8px; --r2:12px;
  --sh:0 2px 12px rgba(13,31,60,.09);
  --sh2:0 4px 24px rgba(13,31,60,.14);
  --sidebar:224px; --header:56px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:14px;height:100%}
body{font-family:'IBM Plex Sans',sans-serif;background:var(--surf);color:var(--text);height:100%;display:flex;overflow:hidden}

/* ‚îÄ‚îÄ LOGIN OVERLAY ‚îÄ‚îÄ */
.login-overlay{
  position:fixed;inset:0;z-index:9999;
  background:linear-gradient(160deg,var(--navy) 0%,var(--navy2) 55%,#1A3A6E 100%);
  display:flex;align-items:center;justify-content:center;
  transition:opacity .4s;
}
.login-overlay.hide{opacity:0;pointer-events:none}
.login-box{
  background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);
  border-radius:20px;padding:48px 44px;text-align:center;
  backdrop-filter:blur(20px);max-width:420px;width:90%;
  box-shadow:0 32px 80px rgba(0,0,0,.4);
}
.login-emblem{
  width:64px;height:64px;background:var(--amber);border-radius:16px;
  display:flex;align-items:center;justify-content:center;
  font-size:1.8rem;font-weight:700;color:var(--navy);
  margin:0 auto 20px;box-shadow:0 0 0 6px rgba(232,146,10,.2);
}
.login-box h2{font-size:1.4rem;font-weight:700;color:#fff;margin-bottom:6px}
.login-box p{font-size:.85rem;color:rgba(255,255,255,.5);margin-bottom:28px;line-height:1.6}
.login-divider{
  display:flex;align-items:center;gap:10px;margin:20px 0;
  color:rgba(255,255,255,.3);font-size:.75rem;
}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.1)}
.login-note{font-size:.72rem;color:rgba(255,255,255,.3);margin-top:20px;line-height:1.6}
#google-btn-wrap{display:flex;justify-content:center}
.login-error{
  background:rgba(192,57,43,.2);border:1px solid rgba(192,57,43,.4);
  color:#FFA0A0;border-radius:8px;padding:10px 14px;
  font-size:.78rem;margin-top:12px;display:none;
}

/* ‚îÄ‚îÄ USER CHIP (topbar) ‚îÄ‚îÄ */
.user-chip{
  display:flex;align-items:center;gap:8px;
  background:rgba(10,122,110,.1);border:1px solid rgba(10,122,110,.2);
  border-radius:20px;padding:4px 12px 4px 6px;cursor:pointer;
  transition:all .15s;
}
.user-chip:hover{background:rgba(10,122,110,.18)}
.user-avatar{
  width:26px;height:26px;border-radius:50%;
  background:var(--teal);color:#fff;font-size:.75rem;font-weight:700;
  display:flex;align-items:center;justify-content:center;overflow:hidden;
}
.user-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.user-name{font-size:.75rem;font-weight:600;color:var(--text);max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.admin-badge{
  font-size:.58rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;
  background:var(--amber);color:var(--navy);padding:1px 5px;border-radius:3px;
}

/* ‚îÄ‚îÄ SYNC STATUS ‚îÄ‚îÄ */
.sync-indicator{
  display:flex;align-items:center;gap:6px;
  font-size:.72rem;padding:4px 10px;border-radius:5px;
  background:var(--surf);border:1px solid var(--border);
}
.sync-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.sync-dot.ok{background:var(--green)}
.sync-dot.pending{background:var(--amber);animation:blink 1.4s infinite}
.sync-dot.error{background:var(--red)}
.sync-dot.off{background:var(--border)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{
  width:var(--sidebar);min-width:var(--sidebar);background:var(--navy);
  display:flex;flex-direction:column;height:100vh;overflow:hidden;
  box-shadow:2px 0 20px rgba(0,0,0,.25);z-index:10;
}
.sb-brand{padding:18px 16px 14px;border-bottom:1px solid rgba(255,255,255,.08)}
.sb-emblem{width:36px;height:36px;background:var(--amber);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:700;color:var(--navy);margin-bottom:8px;box-shadow:0 0 0 3px rgba(232,146,10,.22)}
.sb-title{font-size:.85rem;font-weight:700;color:#fff}
.sb-sub{font-size:.68rem;color:rgba(255,255,255,.42);margin-top:2px}
.sb-section{padding:16px 0 4px 16px;font-size:.62rem;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:.1em;text-transform:uppercase}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 16px;cursor:pointer;border-left:3px solid transparent;color:rgba(255,255,255,.55);font-size:.83rem;font-weight:500;transition:all .15s;user-select:none}
.nav-item:hover{background:rgba(255,255,255,.06);color:rgba(255,255,255,.9)}
.nav-item.active{background:rgba(10,122,110,.2);border-left-color:var(--teal2);color:#fff}
.nav-item.admin-only{display:none}
.nav-item.admin-only.show{display:flex}
.nav-icon{font-size:1rem;width:20px;text-align:center;flex-shrink:0}
.nav-badge{margin-left:auto;background:var(--amber);color:var(--navy);font-size:.62rem;font-weight:700;border-radius:10px;padding:1px 6px;min-width:18px;text-align:center}
.sb-divider{height:1px;background:rgba(255,255,255,.07);margin:8px 0}
.sb-footer{margin-top:auto;padding:12px 16px;border-top:1px solid rgba(255,255,255,.07);font-size:.72rem;color:rgba(255,255,255,.28);line-height:1.5}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{flex:1;display:flex;flex-direction:column;height:100vh;overflow:hidden}
.topbar{height:var(--header);min-height:var(--header);background:var(--white);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;padding:0 20px;box-shadow:0 1px 4px rgba(13,31,60,.06);z-index:5}
.topbar-title{font-size:1rem;font-weight:600;color:var(--text);flex:1}
.topbar-sub{font-size:.75rem;color:var(--muted);margin-left:8px;font-weight:400}
.topbar-right{display:flex;align-items:center;gap:8px;margin-left:auto}
.content{flex:1;overflow-y:auto;padding:20px;scroll-behavior:smooth}
.screen{display:none;animation:fadeIn .2s ease}
.screen.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* ‚îÄ‚îÄ COMPONENTS ‚îÄ‚îÄ */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.stat-card{background:var(--white);border-radius:var(--r2);padding:16px;box-shadow:var(--sh);border-top:3px solid var(--border);display:flex;flex-direction:column;gap:4px;transition:all .15s}
.stat-card:hover{box-shadow:var(--sh2);transform:translateY(-1px)}
.stat-card.c-teal{border-top-color:var(--teal)}.stat-card.c-amber{border-top-color:var(--amber)}
.stat-card.c-green{border-top-color:var(--green)}.stat-card.c-blue{border-top-color:var(--blue)}
.stat-num{font-size:2rem;font-weight:700;color:var(--text);line-height:1;font-family:'IBM Plex Mono',monospace}
.stat-lbl{font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;font-weight:600}
.stat-trend{font-size:.72rem;color:var(--muted);margin-top:2px}
.card{background:var(--white);border-radius:var(--r2);box-shadow:var(--sh);margin-bottom:16px;overflow:hidden}
.card-header{padding:14px 18px;border-bottom:1px solid var(--surf2);display:flex;align-items:center;gap:8px}
.card-header h3{font-size:.88rem;font-weight:600;color:var(--text)}
.card-header .spacer{flex:1}
.card-body{padding:18px}.card-body.p0{padding:0}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.form-wrap{display:grid;grid-template-columns:1fr 280px;gap:16px;align-items:start}
.form-main{display:flex;flex-direction:column;gap:14px}
.form-sidebar-col{display:flex;flex-direction:column;gap:12px;position:sticky;top:0}
.section-block{background:var(--white);border-radius:var(--r2);box-shadow:var(--sh);overflow:hidden}
.section-head{padding:12px 16px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--surf2);background:var(--surf)}
.section-tag{font-size:.62rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--white);background:var(--teal);padding:2px 7px;border-radius:4px}
.section-head h4{font-size:.82rem;font-weight:600;color:var(--text)}
.section-body{padding:16px}
.fields{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.field{display:flex;flex-direction:column;gap:4px}
.field.full{grid-column:1/-1}.field.col2{grid-column:span 2}
label{font-size:.75rem;font-weight:600;color:var(--text)}
label .req{color:var(--red);margin-left:2px}
label .hint-tag{font-size:.62rem;font-weight:600;color:var(--teal);background:rgba(10,122,110,.1);padding:1px 5px;border-radius:3px;margin-left:4px;font-family:'IBM Plex Mono',monospace}
input[type=text],input[type=email],input[type=number],input[type=date],select,textarea{
  border:1.5px solid var(--border);border-radius:var(--r);padding:7px 10px;font-size:.82rem;
  font-family:'IBM Plex Sans',sans-serif;color:var(--text);background:var(--white);
  transition:border-color .15s,box-shadow .15s;width:100%}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--teal);box-shadow:0 0 0 3px rgba(10,122,110,.1)}
input.err,select.err,textarea.err{border-color:var(--red)!important;box-shadow:0 0 0 3px rgba(192,57,43,.1)!important}
textarea{resize:vertical;min-height:72px}
.field-hint{font-size:.68rem;color:var(--muted)}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--r);border:none;font-size:.8rem;font-weight:600;cursor:pointer;font-family:'IBM Plex Sans',sans-serif;transition:all .15s;white-space:nowrap}
.btn-primary{background:var(--teal);color:#fff;box-shadow:0 2px 8px rgba(10,122,110,.28)}
.btn-primary:hover{background:#0A9080;transform:translateY(-1px)}
.btn-primary:disabled{background:#aaa;box-shadow:none;transform:none;cursor:not-allowed}
.btn-secondary{background:var(--surf);color:var(--text);border:1.5px solid var(--border)}
.btn-secondary:hover{background:var(--surf2);border-color:var(--teal);color:var(--teal)}
.btn-danger{background:var(--red);color:#fff}.btn-danger:hover{background:#A02020}
.btn-ghost{background:none;color:var(--muted);border:1.5px solid var(--border)}
.btn-ghost:hover{color:var(--text);border-color:var(--text)}
.btn-sm{padding:5px 10px;font-size:.72rem}
.badge{display:inline-flex;align-items:center;gap:3px;font-size:.68rem;font-weight:700;padding:2px 7px;border-radius:4px;letter-spacing:.03em;text-transform:uppercase}
.badge-pending{background:#FFF3CD;color:#7A4F00}.badge-done{background:#D4EDDA;color:#155724}
.badge-new{background:#D6EAF8;color:#1A4F7A}.badge-review{background:#EDE0FF;color:#5B2F8A}
.badge-canceled{background:#FDECEA;color:#922B21}
.folio-display{background:var(--navy);border-radius:var(--r);padding:10px 14px;display:flex;align-items:center;gap:10px;margin-bottom:4px}
.folio-code{font-family:'IBM Plex Mono',monospace;font-size:1rem;font-weight:500;color:var(--amber2);letter-spacing:.06em}
.folio-label{font-size:.68rem;color:rgba(255,255,255,.4);margin-left:auto}
.alert{display:flex;align-items:flex-start;gap:10px;padding:10px 14px;border-radius:var(--r);font-size:.8rem;border-left:3px solid;margin-top:8px;display:none}
.alert.show{display:flex}
.alert-success{background:#D4EDDA;border-color:var(--green);color:#155724}
.alert-error{background:#FDECEA;border-color:var(--red);color:#922B21}
.alert-info{background:#D6EAF8;border-color:var(--blue);color:#1A4F7A}
.alert-warning{background:#FFF3CD;border-color:var(--amber);color:#7A4F00}
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
thead th{background:var(--navy);color:#fff;font-size:.72rem;text-transform:uppercase;letter-spacing:.06em;font-weight:600;padding:10px 12px;text-align:left;white-space:nowrap}
tbody tr{border-bottom:1px solid var(--surf2);transition:background .1s}
tbody tr:hover{background:var(--surf)}
tbody td{padding:9px 12px;font-size:.8rem;vertical-align:middle}
.empty-state{text-align:center;padding:40px;color:var(--muted);font-size:.85rem}
.empty-state .es-icon{font-size:2.5rem;margin-bottom:8px;opacity:.4}
.info-card{background:var(--white);border-radius:var(--r2);box-shadow:var(--sh);overflow:hidden}
.info-card-head{padding:10px 14px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--surf2)}
.info-card-head .ico{font-size:1.1rem}
.info-card-head h5{font-size:.78rem;font-weight:700;color:var(--text)}
.info-card-body{padding:12px 14px;font-size:.75rem;color:var(--muted);line-height:1.6}
.info-card-body strong{color:var(--text);display:block;margin-bottom:2px}
.info-card-body code{font-family:'IBM Plex Mono',monospace;font-size:.7rem;background:var(--surf2);padding:1px 5px;border-radius:3px;color:var(--teal)}
.timeline{display:flex;flex-direction:column}
.tl-item{display:flex;gap:12px;padding:8px 0;border-left:2px solid var(--surf2);margin-left:8px;padding-left:14px;position:relative}
.tl-item::before{content:'';position:absolute;left:-5px;top:14px;width:8px;height:8px;border-radius:50%;background:var(--teal);border:2px solid var(--white)}
.tl-item.new::before{background:var(--amber)}.tl-item.done::before{background:var(--green)}
.tl-item.cloud::before{background:var(--blue)}
.tl-time{font-size:.68rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;width:76px;flex-shrink:0;padding-top:2px}
.tl-text{font-size:.78rem;color:var(--text);line-height:1.5}
.tl-text strong{color:var(--navy);font-weight:600}
.form-tabs{display:flex;gap:4px;margin-bottom:16px;flex-wrap:wrap}
.form-tab{display:flex;align-items:center;gap:7px;padding:8px 14px;border-radius:var(--r);border:1.5px solid var(--border);background:var(--white);cursor:pointer;transition:all .15s;font-size:.78rem;font-weight:600;color:var(--muted);box-shadow:var(--sh)}
.form-tab:hover{border-color:var(--teal);color:var(--teal)}
.form-tab.active{border-color:var(--teal);background:rgba(10,122,110,.06);color:var(--teal);box-shadow:0 0 0 2px rgba(10,122,110,.12)}
.tab-code{font-family:'IBM Plex Mono',monospace;font-size:.62rem;background:var(--surf2);padding:1px 5px;border-radius:3px;color:var(--muted)}
.form-tab.active .tab-code{background:rgba(10,122,110,.15);color:var(--teal)}
.form-header-strip{padding:14px 18px;background:linear-gradient(135deg,var(--navy) 0%,var(--navy2) 100%);border-radius:var(--r2) var(--r2) 0 0;display:flex;align-items:center;gap:12px}
.fhs-accent{width:4px;align-self:stretch;border-radius:2px;flex-shrink:0}
.fhs-info{flex:1}.fhs-info h3{font-size:.95rem;font-weight:700;color:#fff}
.fhs-info p{font-size:.72rem;color:rgba(255,255,255,.5);margin-top:2px}
.fhs-folio{font-family:'IBM Plex Mono',monospace;font-size:.8rem;color:var(--amber2);background:rgba(255,255,255,.07);padding:5px 10px;border-radius:5px;border:1px solid rgba(255,255,255,.1);white-space:nowrap}
.page-header{margin-bottom:20px}
.page-header h2{font-size:1.2rem;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px}
.page-header p{font-size:.8rem;color:var(--muted);margin-top:4px}
.filter-bar{display:flex;gap:8px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
.filter-bar input{flex:1;min-width:200px}
.filter-bar select{width:160px}
.quick-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.quick-card{background:var(--white);border-radius:var(--r2);box-shadow:var(--sh);padding:16px;cursor:pointer;transition:all .18s;border:2px solid transparent;text-align:center;display:flex;flex-direction:column;align-items:center;gap:8px}
.quick-card:hover{box-shadow:var(--sh2);transform:translateY(-2px);border-color:var(--border)}
.quick-card.qc-pg:hover{border-color:var(--purple);background:rgba(91,47,138,.03)}
.quick-card.qc-sc:hover{border-color:var(--green);background:rgba(26,122,74,.03)}
.quick-card.qc-pr:hover{border-color:var(--orange);background:rgba(184,92,10,.03)}
.quick-card.qc-oe:hover{border-color:var(--blue);background:rgba(27,95,168,.03)}
.quick-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem}
.quick-name{font-size:.82rem;font-weight:700;color:var(--text)}
.quick-code{font-size:.68rem;font-family:'IBM Plex Mono',monospace;color:var(--muted)}
.dash-grid{display:grid;grid-template-columns:1fr 340px;gap:16px}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--surf2);border-radius:3px}
.status-bar{background:var(--white);border-top:1px solid var(--border);padding:6px 20px;display:flex;align-items:center;gap:16px;font-size:.7rem;color:var(--muted)}
.status-bar .sb-ok{color:var(--green);display:flex;align-items:center;gap:4px}
/* Admin-specific */
.admin-section{background:linear-gradient(135deg,rgba(13,31,60,.03),rgba(10,122,110,.04));border:1px solid rgba(10,122,110,.15);border-radius:var(--r2);padding:16px;margin-bottom:16px}
.admin-label{display:flex;align-items:center;gap:6px;font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--teal);margin-bottom:12px}
.admin-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.admin-stat{background:var(--white);border-radius:var(--r);padding:14px;text-align:center;box-shadow:var(--sh)}
.admin-stat .n{font-size:1.8rem;font-weight:700;color:var(--navy);font-family:'IBM Plex Mono',monospace}
.admin-stat .l{font-size:.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
.refresh-bar{display:flex;align-items:center;gap:10px;font-size:.75rem;color:var(--muted);margin-bottom:12px}
.last-refresh{font-family:'IBM Plex Mono',monospace;font-size:.7rem;color:var(--teal)}
.spinner{
  width:16px;height:16px;border-radius:50%;
  border:2px solid var(--border);border-top-color:var(--teal);
  animation:spin .7s linear infinite;display:none;
}
@keyframes spin{to{transform:rotate(360deg)}}
.drive-link{color:var(--teal);text-decoration:none;font-size:.75rem;font-family:'IBM Plex Mono',monospace}
.drive-link:hover{text-decoration:underline}
.tag-admin{background:rgba(13,31,60,.08);color:var(--navy);font-size:.7rem;font-weight:600;padding:2px 7px;border-radius:4px}
/* Chip conectado */
.cloud-status{display:flex;align-items:center;gap:5px;font-size:.72rem;padding:3px 8px;border-radius:5px}
.cloud-status.on{background:#D4EDDA;color:var(--green)}
.cloud-status.off{background:var(--surf);color:var(--muted)}
.cloud-status.syncing{background:#FFF3CD;color:var(--amber)}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOGIN OVERLAY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <div class="login-emblem">C</div>
    <h2>CITRO ‚Äî Sistema de Tr√°mites</h2>
    <p>Inicie sesi√≥n con su cuenta institucional UV<br>para acceder al portal de solicitudes.</p>
    <div id="google-btn-wrap"></div>
    <div class="login-divider">o contin√∫e sin cuenta</div>
    <button class="btn btn-ghost" style="width:100%;justify-content:center" onclick="loginOffline()">
      Continuar sin Google Drive ‚Üó
    </button>
    <div class="login-note">
      Al iniciar sesi√≥n sus tr√°mites se guardan autom√°ticamente<br>
      en Google Drive y en la hoja de registro del CITRO.
    </div>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SIDEBAR
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<nav class="sidebar">
  <div class="sb-brand">
    <div class="sb-emblem">C</div>
    <div class="sb-title">CITRO ‚Äî UV</div>
    <div class="sb-sub">Centro de Inv. Tropicales</div>
  </div>

  <div class="sb-section">Principal</div>
  <div class="nav-item active" data-screen="s-inicio" onclick="nav(this)">
    <span class="nav-icon">üè†</span> Inicio
  </div>
  <div class="nav-item" data-screen="s-tramites" onclick="nav(this)">
    <span class="nav-icon">üìã</span> Mis Tr√°mites
    <span class="nav-badge" id="nb-total">0</span>
  </div>

  <div class="sb-divider"></div>
  <div class="sb-section">Nueva Solicitud</div>
  <div class="nav-item" data-screen="s-form" data-type="pg" onclick="navForm(this)">
    <span class="nav-icon">üì©</span> Petici√≥n General
    <span class="nav-badge" id="nb-pg" style="background:rgba(91,47,138,.6)">0</span>
  </div>
  <div class="nav-item" data-screen="s-form" data-type="sc" onclick="navForm(this)">
    <span class="nav-icon">üåø</span> Salida de Campo
    <span class="nav-badge" id="nb-sc" style="background:rgba(26,122,74,.6)">0</span>
  </div>
  <div class="nav-item" data-screen="s-form" data-type="pr" onclick="navForm(this)">
    <span class="nav-icon">üì¶</span> Petici√≥n Recursos
    <span class="nav-badge" id="nb-pr" style="background:rgba(184,92,10,.6)">0</span>
  </div>
  <div class="nav-item" data-screen="s-form" data-type="oe" onclick="navForm(this)">
    <span class="nav-icon">üéì</span> Org. de Evento
    <span class="nav-badge" id="nb-oe" style="background:rgba(27,95,168,.6)">0</span>
  </div>

  <div class="sb-divider"></div>
  <!-- ADMIN ONLY -->
  <div class="sb-section admin-only" id="sb-admin-section">Administraci√≥n</div>
  <div class="nav-item admin-only" id="nav-admin" data-screen="s-admin" onclick="nav(this)">
    <span class="nav-icon">üîê</span> Panel Admin
    <span class="nav-badge" id="nb-cloud" style="background:rgba(13,31,60,.4)">0</span>
  </div>

  <div class="sb-divider"></div>
  <div class="sb-section">Sistema</div>
  <div class="nav-item" data-screen="s-config" onclick="nav(this)">
    <span class="nav-icon">‚öôÔ∏è</span> Configuraci√≥n
  </div>
  <div class="nav-item" onclick="logout()">
    <span class="nav-icon">üö™</span> Cerrar sesi√≥n
  </div>

  <div class="sb-footer">
    CITRO-Formularios v3.0<br>
    <span style="font-family:'IBM Plex Mono',monospace">CITRO / UV ¬∑ 2025</span>
  </div>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="topbar-title">Inicio <span class="topbar-sub">Panel de control</span></div>
    <div class="topbar-right">
      <div class="sync-indicator" id="syncIndicator">
        <div class="sync-dot off" id="syncDot"></div>
        <span id="syncLabel">Sin conexi√≥n</span>
      </div>
      <div class="user-chip" id="userChip" onclick="toggleUserMenu()" style="display:none">
        <div class="user-avatar" id="userAvatar">?</div>
        <span class="user-name" id="userName">...</span>
        <span class="admin-badge" id="userAdminBadge" style="display:none">ADMIN</span>
      </div>
    </div>
  </div>

  <div class="content">

    <!-- ‚ïê‚ïê‚ïê INICIO ‚ïê‚ïê‚ïê -->
    <div class="screen active" id="s-inicio">
      <div class="page-header">
        <h2>üè† Panel de Control</h2>
        <p>Bienvenido al sistema de gesti√≥n de tr√°mites CITRO ¬∑ Universidad Veracruzana</p>
      </div>
      <div class="stats-row">
        <div class="stat-card c-teal"><div class="stat-num" id="st-total">0</div><div class="stat-lbl">Tr√°mites totales</div><div class="stat-trend">Todos los tipos</div></div>
        <div class="stat-card c-amber"><div class="stat-num" id="st-pend">0</div><div class="stat-lbl">En proceso</div><div class="stat-trend">Pendientes</div></div>
        <div class="stat-card c-green"><div class="stat-num" id="st-done">0</div><div class="stat-lbl">Completados</div><div class="stat-trend">PDF generados</div></div>
        <div class="stat-card c-blue"><div class="stat-num" id="st-today">0</div><div class="stat-lbl">Nuevos hoy</div><div class="stat-trend" id="st-date-lbl">‚Äî</div></div>
      </div>
      <div class="quick-grid">
        <div class="quick-card qc-pg" onclick="navFormDirect('pg')"><div class="quick-icon" style="background:rgba(91,47,138,.1)">üì©</div><div class="quick-name">Petici√≥n General</div><div class="quick-code">PG-YYYY-NNN</div></div>
        <div class="quick-card qc-sc" onclick="navFormDirect('sc')"><div class="quick-icon" style="background:rgba(26,122,74,.1)">üåø</div><div class="quick-name">Salida de Campo</div><div class="quick-code">SC-YYYY-NNN</div></div>
        <div class="quick-card qc-pr" onclick="navFormDirect('pr')"><div class="quick-icon" style="background:rgba(184,92,10,.1)">üì¶</div><div class="quick-name">Petici√≥n de Recursos</div><div class="quick-code">PR-YYYY-NNN</div></div>
        <div class="quick-card qc-oe" onclick="navFormDirect('oe')"><div class="quick-icon" style="background:rgba(27,95,168,.1)">üéì</div><div class="quick-name">Organizaci√≥n de Evento</div><div class="quick-code">OE-YYYY-NNN</div></div>
      </div>
      <div class="dash-grid">
        <div class="card">
          <div class="card-header"><span>üìÖ</span><h3>Actividad Reciente</h3><span class="spacer"></span><button class="btn btn-ghost btn-sm" onclick="nav(document.querySelector('[data-screen=s-tramites]'))">Ver todos ‚Üí</button></div>
          <div class="card-body p0"><div id="dash-timeline" style="padding:12px 16px"><div class="empty-state" id="dash-empty"><div class="es-icon">üì≠</div><p>No hay tr√°mites a√∫n. Use los accesos directos para crear su primera solicitud.</p></div></div></div>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px">
          <div class="card">
            <div class="card-header"><span>üìä</span><h3>Por tipo</h3></div>
            <div class="card-body" style="padding:12px 16px"><div id="type-bars"><div style="text-align:center;padding:16px;color:var(--muted);font-size:.78rem">Sin datos a√∫n</div></div></div>
          </div>
          <div class="card">
            <div class="card-header"><span>‚òÅÔ∏è</span><h3>Estado de sincronizaci√≥n</h3></div>
            <div class="card-body" style="padding:12px 16px;font-size:.78rem">
              <div id="sync-detail" style="color:var(--muted)">Inicie sesi√≥n con Google para activar la sincronizaci√≥n autom√°tica con Drive y la hoja de registros.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê MIS TR√ÅMITES ‚ïê‚ïê‚ïê -->
    <div class="screen" id="s-tramites">
      <div class="page-header"><h2>üìã Mis Tr√°mites</h2><p>Historial de solicitudes registradas en este dispositivo</p></div>
      <div class="card">
        <div class="card-body">
          <div class="filter-bar">
            <input type="text" id="q-search" placeholder="Buscar por folio, nombre o tipo‚Ä¶" oninput="renderTable()"/>
            <select id="q-tipo" onchange="renderTable()"><option value="">Todos los tipos</option><option value="pg">Petici√≥n General</option><option value="sc">Salida de Campo</option><option value="pr">Petici√≥n de Recursos</option><option value="oe">Organizaci√≥n de Evento</option></select>
            <select id="q-estado" onchange="renderTable()"><option value="">Todos los estados</option><option value="Pendiente">Pendiente</option><option value="En revisi√≥n">En revisi√≥n</option><option value="Completado">Completado</option></select>
            <button class="btn btn-primary btn-sm" onclick="exportCSV()">‚¨á CSV</button>
          </div>
          <div class="table-wrap">
            <table id="main-table">
              <thead><tr><th>Folio</th><th>Tipo</th><th>Solicitante</th><th>Matr√≠cula</th><th>Fecha</th><th>Estado</th><th>Drive</th><th>Acciones</th></tr></thead>
              <tbody id="table-body"></tbody>
            </table>
          </div>
          <div class="empty-state" id="table-empty" style="display:none"><div class="es-icon">üì≠</div><p>No se encontraron tr√°mites.</p></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê FORMULARIOS ‚ïê‚ïê‚ïê -->
    <div class="screen" id="s-form">
      <div class="form-tabs" id="form-tabs">
        <div class="form-tab active" data-t="pg" onclick="switchForm('pg',this)"><span>üì©</span> Petici√≥n General <span class="tab-code">PG</span></div>
        <div class="form-tab" data-t="sc" onclick="switchForm('sc',this)"><span>üåø</span> Salida de Campo <span class="tab-code">SC</span></div>
        <div class="form-tab" data-t="pr" onclick="switchForm('pr',this)"><span>üì¶</span> Petici√≥n Recursos <span class="tab-code">PR</span></div>
        <div class="form-tab" data-t="oe" onclick="switchForm('oe',this)"><span>üéì</span> Org. Evento <span class="tab-code">OE</span></div>
      </div>

      <!-- PG -->
      <div id="form-pg" class="form-def">
        <div class="form-wrap">
          <div class="form-main">
            <div class="form-header-strip"><div class="fhs-accent" style="background:var(--purple)"></div><div class="fhs-info"><h3>Nueva Petici√≥n General ‚Äî CITRO / UV</h3><p>Asunto: Petici√≥n General ¬∑ Complete todos los campos obligatorios *</p></div><div class="fhs-folio" id="pg-folio-hdr">PG-YYYY-NNN</div></div>
            <div class="section-block"><div class="section-head"><span class="section-tag" style="background:var(--teal)">01</span><h4>Identificaci√≥n del Solicitante</h4></div><div class="section-body"><div class="fields">
              <div class="field"><label>Apellido(s)<span class="req">*</span></label><input type="text" id="pg-apellidos" placeholder="Garc√≠a Morales"/></div>
              <div class="field"><label>Nombre(s)<span class="req">*</span></label><input type="text" id="pg-nombres" placeholder="Alejandro"/></div>
              <div class="field"><label>Matr√≠cula UV<span class="req">*</span></label><input type="text" id="pg-matricula" placeholder="S23XXXXXX" maxlength="10"/></div>
              <div class="field"><label>Correo institucional<span class="req">*</span></label><input type="email" id="pg-correo" placeholder="s23xxx@estudiantes.uv.mx"/></div>
              <div class="field col2"><label>Programa acad√©mico<span class="req">*</span></label><select id="pg-programa"><option value="">‚Äî Seleccione ‚Äî</option><option>Maestr√≠a en Ciencias Biol√≥gicas</option><option>Maestr√≠a en Ecolog√≠a y Manejo de Recursos</option><option>Doctorado en Ciencias Biol√≥gicas y Agropecuarias</option><option>Doctorado en Ecolog√≠a Tropical</option><option>Otro</option></select></div>
              <div class="field col2"><label>Director(a) de tesis</label><input type="text" id="pg-director" placeholder="Dr./Dra. Nombre Completo"/></div>
            </div></div></div>
            <div class="section-block"><div class="section-head"><span class="section-tag" style="background:var(--purple)">02</span><h4>Datos de la Petici√≥n General</h4></div><div class="section-body"><div class="fields">
              <div class="field col2"><label>Tipo de petici√≥n<span class="req">*</span></label><select id="pg-tipo"><option value="">‚Äî Seleccione tipo ‚Äî</option><optgroup label="Acad√©mico"><option>Pr√≥rroga de inscripci√≥n</option><option>Cambio de director(a) de tesis</option><option>Incorporaci√≥n de co-director(a)</option><option>Cambio de tema de tesis</option><option>Justificaci√≥n de inasistencia</option></optgroup><optgroup label="Administrativo"><option>Constancia de estudios</option><option>Carta de no adeudo</option><option>Acceso a laboratorios / instalaciones</option><option>Apoyo econ√≥mico extraordinario</option></optgroup><optgroup label="Otro"><option>Petici√≥n diversa (describir)</option></optgroup></select></div>
              <div class="field"><label>Fecha de solicitud<span class="req">*</span></label><input type="date" id="pg-fecha"/></div>
              <div class="field"><label>Urgencia</label><select id="pg-urgencia"><option value="Normal (10 d√≠as h√°biles)">Normal (10 d√≠as h√°biles)</option><option value="Prioritario (5 d√≠as h√°biles)">Prioritario (5 d√≠as h√°biles)</option><option value="URGENTE">URGENTE</option></select></div>
              <div class="field full"><label>Descripci√≥n de la petici√≥n<span class="req">*</span></label><textarea id="pg-descripcion" rows="4" placeholder="Exponga detalladamente la petici√≥n, antecedentes, justificaci√≥n y lo que solicita formalmente al CITRO‚Ä¶"></textarea></div>
              <div class="field col2"><label>Documentos adjuntos</label><input type="text" id="pg-adjuntos" placeholder="Archivos separados por coma"/></div>
              <div class="field col2"><label>Observaciones adicionales</label><textarea id="pg-obs" rows="2" placeholder="Informaci√≥n complementaria‚Ä¶"></textarea></div>
            </div></div></div>
            <div id="pg-alert" class="alert alert-success"><span>‚úì</span><span id="pg-alert-msg"></span></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-primary" id="btn-submit-pg" onclick="submitForm('pg')">‚¨á Registrar + Guardar en Drive</button>
              <button class="btn btn-secondary" onclick="resetForm('pg')">‚Ü∫ Limpiar</button>
              <button class="btn btn-ghost" onclick="printForm('pg')">üñ® Imprimir carta</button>
            </div>
          </div>
          <div class="form-sidebar-col">
            <div class="info-card"><div class="info-card-head"><span class="ico">üì©</span><h5>Petici√≥n General</h5></div><div class="info-card-body"><strong>Folio actual</strong><div class="folio-display"><span class="folio-code" id="pg-folio-sb">PG-YYYY-NNN</span><span class="folio-label">Asignado al enviar</span></div><strong style="margin-top:8px">Salida</strong><code>PeticionGeneral_[Mat]_[Apell]_[YYYYMMDD]</code></div></div>
            <div class="info-card" id="sidebar-cloud-pg"><div class="info-card-head"><span class="ico">‚òÅÔ∏è</span><h5>Drive / Sheets</h5></div><div class="info-card-body" id="cloud-status-pg">Al enviar, el documento se guardar√° en Drive y se registrar√° en la hoja de seguimiento CITRO.</div></div>
          </div>
        </div>
      </div>

      <!-- SC -->
      <div id="form-sc" class="form-def" style="display:none">
        <div class="form-wrap">
          <div class="form-main">
            <div class="form-header-strip"><div class="fhs-accent" style="background:var(--green)"></div><div class="fhs-info"><h3>Carta de Salida de Campo ‚Äî CITRO / UV</h3><p>Asunto: Solicitud de Aval para Salida de Campo</p></div><div class="fhs-folio" id="sc-folio-hdr">SC-YYYY-NNN</div></div>
            <div class="section-block"><div class="section-head"><span class="section-tag" style="background:var(--teal)">01</span><h4>Identificaci√≥n del Solicitante</h4></div><div class="section-body"><div class="fields">
              <div class="field"><label>Apellido(s)<span class="req">*</span></label><input type="text" id="sc-apellidos" placeholder="Garc√≠a Morales"/></div>
              <div class="field"><label>Nombre(s)<span class="req">*</span></label><input type="text" id="sc-nombres" placeholder="Alejandro"/></div>
              <div class="field"><label>Grado acad√©mico<span class="req">*</span></label><select id="sc-grado"><option value="">‚Äî Grado ‚Äî</option><option>Lic.</option><option>Ing.</option><option>M.C.</option><option>M.S.</option><option>Dr.</option><option>Dra.</option></select></div>
              <div class="field"><label>Matr√≠cula UV<span class="req">*</span></label><input type="text" id="sc-matricula" placeholder="S23XXXXXX"/></div>
              <div class="field col2"><label>Correo institucional<span class="req">*</span></label><input type="email" id="sc-correo" placeholder="s23xxx@estudiantes.uv.mx"/></div>
              <div class="field col2"><label>Director(a) de tesis</label><input type="text" id="sc-director" placeholder="Dr./Dra. Nombre Completo"/></div>
            </div></div></div>
            <div class="section-block"><div class="section-head"><span class="section-tag" style="background:var(--green)">02</span><h4>Datos de la Salida de Campo</h4></div><div class="section-body"><div class="fields">
              <div class="field full"><label>Lugar(es) de la salida <span class="hint-tag">[Lugares]</span><span class="req">*</span></label><textarea id="sc-lugares" rows="3" placeholder="Municipios, ejidos, reservas, coordenadas‚Ä¶"></textarea></div>
              <div class="field full"><label>Actividades a realizar <span class="hint-tag">[Actividades]</span><span class="req">*</span></label><textarea id="sc-actividades" rows="3" placeholder="Muestreo, colecta, entrevistas, mediciones‚Ä¶"></textarea></div>
              <div class="field"><label>Fecha de salida <span class="hint-tag">[Fecha]</span><span class="req">*</span></label><input type="date" id="sc-fecha-salida"/></div>
              <div class="field"><label>Fecha de regreso<span class="req">*</span></label><input type="date" id="sc-fecha-regreso"/></div>
              <div class="field"><label>N.¬∞ de participantes</label><input type="number" id="sc-participantes" placeholder="4" min="1"/></div>
              <div class="field"><label>Veh√≠culo / Transporte</label><input type="text" id="sc-transporte" placeholder="Veh√≠culo institucional"/></div>
            </div></div></div>
            <div id="sc-alert" class="alert alert-success"><span>‚úì</span><span id="sc-alert-msg"></span></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-primary" id="btn-submit-sc" onclick="submitForm('sc')">‚¨á Registrar + Guardar en Drive</button>
              <button class="btn btn-secondary" onclick="resetForm('sc')">‚Ü∫ Limpiar</button>
              <button class="btn btn-ghost" onclick="printForm('sc')">üñ® Imprimir carta</button>
            </div>
          </div>
          <div class="form-sidebar-col">
            <div class="info-card"><div class="info-card-head"><span class="ico">üåø</span><h5>Salida de Campo</h5></div><div class="info-card-body"><strong>Folio actual</strong><div class="folio-display"><span class="folio-code" id="sc-folio-sb">SC-YYYY-NNN</span><span class="folio-label">Asignado al enviar</span></div><strong style="margin-top:8px">Campos plantilla</strong><code>[Nombre y grado]</code> <code>[Lugares]</code> <code>[Actividades]</code> <code>[Fecha]</code></div></div>
          </div>
        </div>
      </div>

      <!-- PR -->
      <div id="form-pr" class="form-def" style="display:none">
        <div class="form-wrap">
          <div class="form-main">
            <div class="form-header-strip"><div class="fhs-accent" style="background:var(--orange)"></div><div class="fhs-info"><h3>Petici√≥n de Recursos Acad√©micos ‚Äî CITRO / UV</h3><p>Asunto: Solicitud de Recursos Acad√©micos</p></div><div class="fhs-folio" id="pr-folio-hdr">PR-YYYY-NNN</div></div>
            <div class="section-block"><div class="section-head"><span class="section-tag" style="background:var(--teal)">01</span><h4>Identificaci√≥n del Solicitante</h4></div><div class="section-body"><div class="fields">
              <div class="field"><label>Apellido(s) <span class="hint-tag">[Nombre]</span><span class="req">*</span></label><input type="text" id="pr-apellidos" placeholder="Garc√≠a Morales"/></div>
              <div class="field"><label>Nombre(s)<span class="req">*</span></label><input type="text" id="pr-nombres" placeholder="Alejandro"/></div>
              <div class="field"><label>Matr√≠cula UV <span class="hint-tag">[Matr√≠cula]</span><span class="req">*</span></label><input type="text" id="pr-matricula" placeholder="S23XXXXXX"/></div>
              <div class="field"><label>Correo institucional</label><input type="email" id="pr-correo" placeholder="s23xxx@estudiantes.uv.mx"/></div>
              <div class="field col2"><label>Programa acad√©mico</label><select id="pr-programa"><option value="">‚Äî Seleccione ‚Äî</option><option>Maestr√≠a en Ciencias Biol√≥gicas</option><option>Maestr√≠a en Ecolog√≠a y Manejo de Recursos</option><option>Doctorado en Ciencias Biol√≥gicas y Agropecuarias</option><option>Doctorado en Ecolog√≠a Tropical</option><option>Otro</option></select></div>
            </div></div></div>
            <div class="section-block"><div class="section-head"><span class="section-tag" style="background:var(--orange)">02</span><h4>Datos de la Petici√≥n de Recursos</h4></div><div class="section-body"><div class="fields">
              <div class="field full"><label>Actividad acad√©mica <span class="hint-tag">[Actividad]</span><span class="req">*</span></label><input type="text" id="pr-actividad" placeholder="Nombre de la actividad para la que se solicitan los recursos‚Ä¶"/></div>
              <div class="field full"><label>Justificaci√≥n <span class="hint-tag">[Justificaci√≥n]</span><span class="req">*</span></label><textarea id="pr-justificacion" rows="4" placeholder="Argumente la necesidad, pertinencia e impacto acad√©mico‚Ä¶"></textarea></div>
              <div class="field col2"><label>Tipo de recurso solicitado<span class="req">*</span></label><select id="pr-tipo"><option value="">‚Äî Seleccione ‚Äî</option><option>Materiales de laboratorio</option><option>Equipamiento cient√≠fico</option><option>Reactivos y consumibles</option><option>Software / Licencias</option><option>Vi√°ticos y transporte</option><option>Apoyo bibliogr√°fico</option><option>Apoyo t√©cnico / servicios</option><option>Otro</option></select></div>
              <div class="field"><label>Monto estimado (MXN)</label><input type="number" id="pr-monto" placeholder="0.00" min="0" step="0.01"/></div>
              <div class="field"><label>Proyecto / Cuenta asociada</label><input type="text" id="pr-proyecto" placeholder="Clave del proyecto"/></div>
              <div class="field"><label>Fecha requerida<span class="req">*</span></label><input type="date" id="pr-fecha"/></div>
            </div></div></div>
            <div id="pr-alert" class="alert alert-success"><span>‚úì</span><span id="pr-alert-msg"></span></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-primary" id="btn-submit-pr" onclick="submitForm('pr')">‚¨á Registrar + Guardar en Drive</button>
              <button class="btn btn-secondary" onclick="resetForm('pr')">‚Ü∫ Limpiar</button>
              <button class="btn btn-ghost" onclick="printForm('pr')">üñ® Imprimir</button>
            </div>
          </div>
          <div class="form-sidebar-col">
            <div class="info-card"><div class="info-card-head"><span class="ico">üì¶</span><h5>Petici√≥n de Recursos</h5></div><div class="info-card-body"><strong>Folio actual</strong><div class="folio-display"><span class="folio-code" id="pr-folio-sb">PR-YYYY-NNN</span><span class="folio-label">Asignado al enviar</span></div><strong style="margin-top:8px">Campos plantilla</strong><code>[Actividad]</code> <code>[Justificaci√≥n]</code> <code>[Nombre]</code> <code>[Matr√≠cula]</code></div></div>
          </div>
        </div>
      </div>

      <!-- OE -->
      <div id="form-oe" class="form-def" style="display:none">
        <div class="form-wrap">
          <div class="form-main">
            <div class="form-header-strip"><div class="fhs-accent" style="background:var(--blue)"></div><div class="fhs-info"><h3>Organizaci√≥n de Evento Acad√©mico ‚Äî CITRO / UV</h3><p>Asunto: Solicitud de Aval para Organizaci√≥n de Evento Acad√©mico</p></div><div class="fhs-folio" id="oe-folio-hdr">OE-YYYY-NNN</div></div>
            <div class="section-block"><div class="section-head"><span class="section-tag" style="background:var(--teal)">01</span><h4>Identificaci√≥n del Solicitante</h4></div><div class="section-body"><div class="fields">
              <div class="field"><label>Apellido(s)<span class="req">*</span></label><input type="text" id="oe-apellidos" placeholder="Garc√≠a Morales"/></div>
              <div class="field"><label>Nombre(s)<span class="req">*</span></label><input type="text" id="oe-nombres" placeholder="Alejandro"/></div>
              <div class="field"><label>Matr√≠cula UV<span class="req">*</span></label><input type="text" id="oe-matricula" placeholder="S23XXXXXX"/></div>
              <div class="field"><label>Correo institucional</label><input type="email" id="oe-correo" placeholder="s23xxx@estudiantes.uv.mx"/></div>
              <div class="field col2"><label>Programa acad√©mico</label><select id="oe-programa"><option value="">‚Äî Seleccione ‚Äî</option><option>Maestr√≠a en Ciencias Biol√≥gicas</option><option>Maestr√≠a en Ecolog√≠a y Manejo de Recursos</option><option>Doctorado en Ciencias Biol√≥gicas y Agropecuarias</option><option>Doctorado en Ecolog√≠a Tropical</option><option>Otro</option></select></div>
            </div></div></div>
            <div class="section-block"><div class="section-head"><span class="section-tag" style="background:var(--blue)">02</span><h4>Datos del Evento Acad√©mico</h4></div><div class="section-body"><div class="fields">
              <div class="field full"><label>Nombre del evento <span class="hint-tag">[Evento]</span><span class="req">*</span></label><input type="text" id="oe-nombre" placeholder="T√≠tulo del congreso, simposio, taller, seminario‚Ä¶"/></div>
              <div class="field"><label>Fecha del evento <span class="hint-tag">[Datos]</span><span class="req">*</span></label><input type="date" id="oe-fecha"/></div>
              <div class="field col2"><label>Sede / Lugar <span class="hint-tag">[Datos]</span><span class="req">*</span></label><input type="text" id="oe-sede" placeholder="Instalaci√≥n, municipio, estado‚Ä¶"/></div>
              <div class="field"><label>Presupuesto (MXN) <span class="hint-tag">[Monto]</span><span class="req">*</span></label><input type="number" id="oe-presupuesto" placeholder="0.00" min="0" step="0.01"/></div>
              <div class="field"><label>N.¬∞ asistentes <span class="hint-tag">[N√∫mero]</span><span class="req">*</span></label><input type="number" id="oe-asistentes" placeholder="80" min="1"/></div>
              <div class="field full"><label>Proyecto asociado <span class="hint-tag">[Proyecto]</span><span class="req">*</span></label><input type="text" id="oe-proyecto" placeholder="Clave o nombre del proyecto de investigaci√≥n vinculado al evento"/></div>
              <div class="field full"><label>Impacto en LGAC / PLADEA <span class="hint-tag">[Descripci√≥n]</span><span class="req">*</span></label><textarea id="oe-lgac" rows="4" placeholder="Relaci√≥n con las LGAC y el PLADEA de la entidad acad√©mica‚Ä¶"></textarea></div>
            </div></div></div>
            <div id="oe-alert" class="alert alert-success"><span>‚úì</span><span id="oe-alert-msg"></span></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-primary" id="btn-submit-oe" onclick="submitForm('oe')">‚¨á Registrar + Guardar en Drive</button>
              <button class="btn btn-secondary" onclick="resetForm('oe')">‚Ü∫ Limpiar</button>
              <button class="btn btn-ghost" onclick="printForm('oe')">üñ® Imprimir carta</button>
            </div>
          </div>
          <div class="form-sidebar-col">
            <div class="info-card"><div class="info-card-head"><span class="ico">üéì</span><h5>Organizaci√≥n de Evento</h5></div><div class="info-card-body"><strong>Folio actual</strong><div class="folio-display"><span class="folio-code" id="oe-folio-sb">OE-YYYY-NNN</span><span class="folio-label">Asignado al enviar</span></div><strong style="margin-top:8px">Campos plantilla</strong><code>[Evento]</code> <code>[Datos]</code> <code>[Monto]</code> <code>[N√∫mero]</code> <code>[Proyecto]</code> <code>[Descripci√≥n]</code></div></div>
          </div>
        </div>
      </div>
    </div><!-- /s-form -->

    <!-- ‚ïê‚ïê‚ïê PANEL ADMINISTRACI√ìN ‚ïê‚ïê‚ïê -->
    <div class="screen" id="s-admin">
      <div class="page-header">
        <h2>üîê Panel de Administraci√≥n</h2>
        <p>Vista exclusiva para administradores CITRO ¬∑ Datos sincronizados desde Google Sheets</p>
      </div>

      <!-- Stats globales Drive -->
      <div class="admin-section">
        <div class="admin-label">üìä Estad√≠sticas globales (Google Sheets)</div>
        <div class="admin-grid" id="admin-stats-grid">
          <div class="admin-stat"><div class="n" id="adm-total">‚Äî</div><div class="l">Total registros</div></div>
          <div class="admin-stat"><div class="n" id="adm-pend">‚Äî</div><div class="l">Pendientes</div></div>
          <div class="admin-stat"><div class="n" id="adm-done">‚Äî</div><div class="l">Completados</div></div>
          <div class="admin-stat"><div class="n" id="adm-hoy">‚Äî</div><div class="l">Hoy</div></div>
        </div>
      </div>

      <!-- Todos los tr√°mites (Sheet) -->
      <div class="card">
        <div class="card-header">
          <span>üìã</span><h3>Todos los Tr√°mites ‚Äî Registro Central</h3>
          <span class="spacer"></span>
          <div class="refresh-bar">
            <div class="spinner" id="adminSpinner"></div>
            <span>√öltima actualizaci√≥n: <span class="last-refresh" id="lastRefreshLbl">‚Äî</span></span>
          </div>
          <button class="btn btn-primary btn-sm" onclick="refreshAdminData(true)">‚Ü∫ Actualizar</button>
          <button class="btn btn-secondary btn-sm" onclick="exportAdminCSV()">‚¨á CSV</button>
        </div>
        <div class="card-body p0">
          <div style="padding:10px 16px;background:var(--surf);border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap">
            <input type="text" id="adm-search" placeholder="Buscar‚Ä¶" style="width:220px" oninput="renderAdminTable()"/>
            <select id="adm-tipo" onchange="renderAdminTable()" style="width:180px"><option value="">Todos los tipos</option><option value="Petici√≥n General">Petici√≥n General</option><option value="Salida de Campo">Salida de Campo</option><option value="Petici√≥n de Recursos">Petici√≥n de Recursos</option><option value="Organizaci√≥n de Evento">Organizaci√≥n de Evento</option></select>
            <select id="adm-estado" onchange="renderAdminTable()" style="width:160px"><option value="">Todos los estados</option><option>Pendiente</option><option>En revisi√≥n</option><option>Completado</option><option>Cancelado</option></select>
          </div>
          <div class="table-wrap">
            <table id="admin-table">
              <thead><tr><th>Folio</th><th>Tipo</th><th>Apellidos</th><th>Matr√≠cula</th><th>Correo</th><th>Fecha Registro</th><th>Estado</th><th>Drive</th><th>Acciones</th></tr></thead>
              <tbody id="admin-tbody"></tbody>
            </table>
          </div>
          <div class="empty-state" id="admin-empty" style="display:none"><div class="es-icon">üì≠</div><p>Sin registros en el servidor. Actualice o espere a que los usuarios env√≠en solicitudes.</p></div>
        </div>
      </div>

      <!-- Gesti√≥n de admins -->
      <div class="card">
        <div class="card-header"><span>üë§</span><h3>Administradores autorizados</h3></div>
        <div class="card-body">
          <div id="admins-list" style="margin-bottom:16px;display:flex;flex-wrap:wrap;gap:8px">
            <span style="font-size:.8rem;color:var(--muted)">Cargando lista de admins‚Ä¶</span>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <input type="email" id="new-admin-email" placeholder="correo@uv.mx" style="width:240px"/>
            <input type="text" id="new-admin-nombre" placeholder="Nombre completo (opcional)" style="width:200px"/>
            <button class="btn btn-primary btn-sm" onclick="addAdmin()">+ Agregar admin</button>
          </div>
          <div id="admin-msg" class="alert" style="margin-top:10px"></div>
        </div>
      </div>
    </div><!-- /s-admin -->

    <!-- ‚ïê‚ïê‚ïê CONFIGURACI√ìN ‚ïê‚ïê‚ïê -->
    <div class="screen" id="s-config">
      <div class="page-header"><h2>‚öôÔ∏è Configuraci√≥n</h2><p>Ajustes del sistema CITRO-Formularios</p></div>
      <div class="card">
        <div class="card-header"><span>‚òÅÔ∏è</span><h3>Conexi√≥n Google Drive / Sheets</h3></div>
        <div class="card-body">
          <div class="alert alert-info show" style="margin-bottom:12px">
            <span>‚ÑπÔ∏è</span><span>Configure la URL del backend (Google Apps Script desplegado como Web App) para activar la sincronizaci√≥n con Drive y Sheets.</span>
          </div>
          <div class="fields">
            <div class="field full"><label>URL del Web App (Google Apps Script)<span class="req">*</span></label>
              <input type="text" id="cfg-gas-url" placeholder="https://script.google.com/macros/s/XXXX/exec"/>
              <span class="field-hint">Obtiene esta URL al desplegar el script CITRO_Backend.gs como Web App</span>
            </div>
            <div class="field full"><label>Token secreto compartido<span class="req">*</span></label>
              <input type="text" id="cfg-secret" placeholder="citro-uv-2025-secret"/>
              <span class="field-hint">Debe coincidir con la constante SECRET_TOKEN en el script GAS</span>
            </div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn btn-primary" onclick="saveConfig()">üíæ Guardar y probar conexi√≥n</button>
            <div id="conn-test-result" style="display:flex;align-items:center;font-size:.8rem;color:var(--muted);gap:6px"></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><span>üè´</span><h3>Datos institucionales</h3></div>
        <div class="card-body">
          <div class="g2">
            <div class="field"><label>Instituci√≥n</label><input type="text" id="cfg-inst" value="Centro de Investigaciones Tropicales (CITRO)"/></div>
            <div class="field"><label>Universidad</label><input type="text" id="cfg-uni" value="Universidad Veracruzana"/></div>
            <div class="field"><label>Director(a) CITRO</label><input type="text" id="cfg-director" placeholder="Dr./Dra. Nombre del Director"/></div>
            <div class="field"><label>Correo CITRO</label><input type="email" id="cfg-mail" placeholder="citro@uv.mx"/></div>
          </div>
          <button class="btn btn-primary" style="margin-top:12px" onclick="saveInstitConfig()">üíæ Guardar</button>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><span>üìä</span><h3>Datos locales</h3></div>
        <div class="card-body">
          <div id="config-stats" style="font-size:.82rem;color:var(--muted);line-height:2"></div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="exportCSV()">‚¨á CSV local</button>
            <button class="btn btn-secondary btn-sm" onclick="exportJSON()">‚¨á JSON backup</button>
            <button class="btn btn-danger btn-sm" onclick="clearAll()">üóë Borrar datos locales</button>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->

  <div class="status-bar">
    <span class="sb-ok">‚óè Sistema activo</span>
    <span id="sb-version">CITRO-Formularios v3.0</span>
    <span id="sb-user-status" style="color:var(--muted)">Sin sesi√≥n</span>
    <span style="margin-left:auto" id="sb-count">0 tr√°mites</span>
  </div>
</div><!-- /main -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIGURACI√ìN - editar si no se usa el panel de Config
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_GAS_URL = ''; // pegar URL del Web App aqu√≠
const DEFAULT_SECRET  = 'citro-uv-2025-secret';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ESTADO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STORAGE_KEY    = 'citro_tramites_v3';
const FOLIO_KEY      = 'citro_folios_v3';
const CFG_KEY        = 'citro_config_v3';
const ADMIN_CACHE_KEY= 'citro_admin_cache';
const ADMIN_STAMP_KEY= 'citro_admin_stamp';

function loadData()   { try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch{ return []; } }
function saveData(d)  { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }
function loadFolios() { try{ return JSON.parse(localStorage.getItem(FOLIO_KEY)||'{"PG":0,"SC":0,"PR":0,"OE":0}'); }catch{ return {PG:0,SC:0,PR:0,OE:0}; } }
function saveFolios(f){ localStorage.setItem(FOLIO_KEY, JSON.stringify(f)); }
function loadCfg()    { try{ return JSON.parse(localStorage.getItem(CFG_KEY)||'{}'); }catch{ return {}; } }
function saveCfg(c)   { localStorage.setItem(CFG_KEY, JSON.stringify(c)); }

let data       = loadData();
let folios     = loadFolios();
let cfg        = loadCfg();
let currentUser= null;  // { email, name, picture, isAdmin }
let adminData  = [];    // datos del servidor (solo admins)
let isOnline   = false;

const TYPE_LABELS   = {pg:'Petici√≥n General',sc:'Salida de Campo',pr:'Petici√≥n de Recursos',oe:'Organizaci√≥n de Evento'};
const TYPE_PREFIXES = {pg:'PG',sc:'SC',pr:'PR',oe:'OE'};
const TYPE_COLORS   = {pg:'var(--purple)',sc:'var(--green)',pr:'var(--orange)',oe:'var(--blue)'};
const TYPE_ICONS    = {pg:'üì©',sc:'üåø',pr:'üì¶',oe:'üéì'};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GOOGLE SIGN-IN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GOOGLE_CLIENT_ID = cfg.googleClientId || 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';

function initGoogleSignIn() {
  if(typeof google === 'undefined') {
    setTimeout(initGoogleSignIn, 800);
    return;
  }
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleCredentialResponse,
    auto_select: false,
    cancel_on_tap_outside: false,
  });
  google.accounts.id.renderButton(
    document.getElementById('google-btn-wrap'), {
      theme:'filled_black', size:'large', text:'signin_with',
      shape:'rectangular', locale:'es', width:320
    }
  );
  // Try auto-login if previous session
  const savedUser = sessionStorage.getItem('citro_user');
  if(savedUser) {
    try { finishLogin(JSON.parse(savedUser)); } catch{}
  }
}

function handleCredentialResponse(response) {
  // Decode JWT payload (public, not secret)
  const [,payload] = response.credential.split('.');
  const decoded = JSON.parse(atob(payload.replace(/-/g,'+').replace(/_/g,'/')));
  const user = {
    email:   decoded.email,
    name:    decoded.name || decoded.email,
    picture: decoded.picture || '',
    token:   response.credential,
    isAdmin: false,
  };
  sessionStorage.setItem('citro_user', JSON.stringify(user));
  // Check admin status via GAS
  checkAdminStatus(user);
}

async function checkAdminStatus(user) {
  const gasUrl = cfg.gasUrl || DEFAULT_GAS_URL;
  const secret = cfg.secret || DEFAULT_SECRET;

  if(!gasUrl) {
    user.isAdmin = false;
    finishLogin(user);
    return;
  }

  try {
    const r = await fetch(`${gasUrl}?action=tramites&email=${encodeURIComponent(user.email)}&secret=${encodeURIComponent(secret)}`);
    const j = await r.json();
    user.isAdmin = j.ok !== false; // If access granted ‚Üí admin
    if(user.isAdmin) isOnline = true;
  } catch {
    user.isAdmin = false;
  }
  finishLogin(user);
}

function finishLogin(user) {
  currentUser = user;
  sessionStorage.setItem('citro_user', JSON.stringify(user));

  // Hide overlay
  document.getElementById('loginOverlay').classList.add('hide');

  // Update topbar
  const chip = document.getElementById('userChip');
  chip.style.display = 'flex';
  document.getElementById('userName').textContent = user.name.split(' ')[0];
  document.getElementById('sb-user-status').textContent = user.email;

  const av = document.getElementById('userAvatar');
  if(user.picture) av.innerHTML = `<img src="${user.picture}" alt=""/>`;
  else av.textContent = user.name.charAt(0).toUpperCase();

  if(user.isAdmin) {
    document.getElementById('userAdminBadge').style.display = 'inline';
    document.querySelectorAll('.admin-only').forEach(el => el.classList.add('show'));
    document.getElementById('sb-admin-section').classList.add('show');
    setSyncStatus('on', `Conectado como admin  -  ${user.email}`);
  } else {
    setSyncStatus(isOnline ? 'on' : 'off', isOnline ? `Conectado  -  ${user.email}` : `Sin Drive  -  ${user.email}`);
  }

  updateAllCounters();
  renderDashboard();
}

function loginOffline() {
  document.getElementById('loginOverlay').classList.add('hide');
  setSyncStatus('off', 'Sin Drive - datos solo locales');
  document.getElementById('sb-user-status').textContent = 'Sin sesi√≥n Google';
  updateAllCounters();
  renderDashboard();
}

function logout() {
  if(!confirm('¬øCerrar sesi√≥n?')) return;
  currentUser = null;
  sessionStorage.removeItem('citro_user');
  document.getElementById('userChip').style.display = 'none';
  document.getElementById('userAdminBadge').style.display = 'none';
  document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('show'));
  setSyncStatus('off', 'Sin conexi√≥n');
  document.getElementById('loginOverlay').classList.remove('hide');
}

function setSyncStatus(state, label) {
  const dot  = document.getElementById('syncDot');
  const lbl  = document.getElementById('syncLabel');
  dot.className = 'sync-dot ' + state;
  lbl.textContent = label;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRIVE + SHEETS - llamadas al backend GAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function syncToDrive(record) {
  const gasUrl = cfg.gasUrl || DEFAULT_GAS_URL;
  const secret = cfg.secret || DEFAULT_SECRET;
  if(!gasUrl) return { ok: false, skipped: true };

  setSyncStatus('pending', 'Sincronizando‚Ä¶');
  try {
    const r = await fetch(gasUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'register',
        secret,
        record,
        userEmail: currentUser ? currentUser.email : 'an√≥nimo',
      }),
    });
    const j = await r.json();
    if(j.ok) {
      isOnline = true;
      setSyncStatus('on', `Guardado en Drive  -  ${new Date().toLocaleTimeString('es-MX')}`);
      return { ok: true, driveUrl: j.driveUrl };
    } else {
      setSyncStatus('error', 'Error en servidor');
      return { ok: false, error: j.error };
    }
  } catch(e) {
    setSyncStatus('error', 'Sin conexi√≥n a Drive');
    return { ok: false, error: e.message };
  }
}

async function refreshAdminData(force=false) {
  const gasUrl = cfg.gasUrl || DEFAULT_GAS_URL;
  const secret = cfg.secret || DEFAULT_SECRET;
  if(!currentUser || !currentUser.isAdmin || !gasUrl) {
    document.getElementById('admin-empty').style.display='block';
    return;
  }

  // Daily cache
  const stamp = localStorage.getItem(ADMIN_STAMP_KEY);
  const today = new Date().toISOString().split('T')[0];
  if(!force && stamp === today) {
    try {
      adminData = JSON.parse(localStorage.getItem(ADMIN_CACHE_KEY)||'[]');
      if(adminData.length) { renderAdminTable(); loadAdminStats(); loadAdminList(); return; }
    } catch {}
  }

  const sp = document.getElementById('adminSpinner');
  sp.style.display='block';
  try {
    const [rTramites, rStats, rAdmins] = await Promise.all([
      fetch(`${gasUrl}?action=tramites&email=${encodeURIComponent(currentUser.email)}&secret=${encodeURIComponent(secret)}`),
      fetch(`${gasUrl}?action=stats&email=${encodeURIComponent(currentUser.email)}&secret=${encodeURIComponent(secret)}`),
      fetch(`${gasUrl}?action=admins&email=${encodeURIComponent(currentUser.email)}&secret=${encodeURIComponent(secret)}`),
    ]);
    const jT = await rTramites.json();
    const jS = await rStats.json();
    const jA = await rAdmins.json();

    if(jT.ok) {
      adminData = jT.data || [];
      localStorage.setItem(ADMIN_CACHE_KEY, JSON.stringify(adminData));
      localStorage.setItem(ADMIN_STAMP_KEY, today);
      renderAdminTable();
    }
    if(jS.ok) updateAdminStats(jS.data);
    if(jA.ok) renderAdminList(jA.data);

    document.getElementById('lastRefreshLbl').textContent = new Date().toLocaleTimeString('es-MX');
    document.getElementById('nb-cloud').textContent = adminData.length;
  } catch(e) {
    showAdminMsg('error', 'Error al conectar con el servidor: '+e.message);
  } finally {
    sp.style.display='none';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVEGACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SCREEN_TITLES = {
  's-inicio':   ['üè† Inicio','Panel de control'],
  's-tramites': ['üìã Mis Tr√°mites','Historial completo'],
  's-form':     ['üìù Nueva Solicitud','Formularios CITRO'],
  's-admin':    ['üîê Panel de Administraci√≥n','Solo administradores'],
  's-config':   ['‚öôÔ∏è Configuraci√≥n','Ajustes del sistema'],
};

function nav(el) {
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  el.classList.add('active');
  const sid = el.dataset.screen;
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(sid).classList.add('active');
  const t = SCREEN_TITLES[sid]||['CITRO',''];
  document.getElementById('topbar-title').innerHTML =
    t[0]+(t[1]?` <span class="topbar-sub">${t[1]}</span>`:'');
  if(sid==='s-tramites') renderTable();
  if(sid==='s-inicio')   renderDashboard();
  if(sid==='s-config')   renderConfigStats();
  if(sid==='s-admin')    refreshAdminData();
}

function navForm(el) {
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('s-form').classList.add('active');
  const type = el.dataset.type;
  switchForm(type, document.querySelector(`.form-tab[data-t="${type}"]`));
  document.getElementById('topbar-title').innerHTML =
    `üìù ${TYPE_ICONS[type]} ${TYPE_LABELS[type]} <span class="topbar-sub">Nueva solicitud</span>`;
}

function navFormDirect(type) {
  navForm({dataset:{screen:'s-form',type},classList:{add(){},remove(){}}});
  document.querySelectorAll('.nav-item').forEach(n=>{
    n.classList.remove('active');
    if(n.dataset.type===type) n.classList.add('active');
  });
}

function switchForm(type, tabEl) {
  document.querySelectorAll('.form-def').forEach(f=>f.style.display='none');
  document.getElementById('form-'+type).style.display='block';
  document.querySelectorAll('.form-tab').forEach(t=>t.classList.remove('active'));
  if(tabEl) tabEl.classList.add('active');
  else { const t=document.querySelector(`.form-tab[data-t="${type}"]`); if(t) t.classList.add('active'); }
  updateFolioPreview(type);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FOLIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function previewFolio(type){ const p=TYPE_PREFIXES[type]; return `${p}-${new Date().getFullYear()}-${String((folios[p]||0)+1).padStart(3,'0')}`; }
function assignFolio(type){ const p=TYPE_PREFIXES[type]; folios[p]=(folios[p]||0)+1; saveFolios(folios); return `${p}-${new Date().getFullYear()}-${String(folios[p]).padStart(3,'0')}`; }
function updateFolioPreview(type){ const f=previewFolio(type); ['hdr','sb'].forEach(s=>{ const el=document.getElementById(`${type}-folio-${s}`); if(el) el.textContent=f; }); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUBMIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FORM_REQUIRED = {
  pg:['pg-apellidos','pg-nombres','pg-matricula','pg-correo','pg-programa','pg-tipo','pg-descripcion','pg-fecha'],
  sc:['sc-apellidos','sc-nombres','sc-grado','sc-matricula','sc-correo','sc-lugares','sc-actividades','sc-fecha-salida','sc-fecha-regreso'],
  pr:['pr-apellidos','pr-nombres','pr-matricula','pr-actividad','pr-justificacion','pr-tipo','pr-fecha'],
  oe:['oe-apellidos','oe-nombres','oe-matricula','oe-nombre','oe-fecha','oe-sede','oe-presupuesto','oe-asistentes','oe-proyecto','oe-lgac'],
};

function validate(type){ let ok=true; FORM_REQUIRED[type].forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(!el.value.trim()){el.classList.add('err');ok=false;}else el.classList.remove('err'); }); return ok; }

function buildRecord(type, folio) {
  const g=id=>(document.getElementById(id)||{value:''}).value.trim();
  const base={folio,type,label:TYPE_LABELS[type],fecha:new Date().toISOString(),estado:'Pendiente',apellidos:g(type+'-apellidos'),nombres:g(type+'-nombres'),matricula:g(type+'-matricula'),correo:g(type+'-correo'),driveUrl:''};
  if(type==='pg') return{...base,programa:g('pg-programa'),director:g('pg-director'),tipo:g('pg-tipo'),urgencia:g('pg-urgencia'),descripcion:g('pg-descripcion'),adjuntos:g('pg-adjuntos'),obs:g('pg-obs'),fecha_sol:g('pg-fecha')};
  if(type==='sc') return{...base,grado:g('sc-grado'),director:g('sc-director'),lugares:g('sc-lugares'),actividades:g('sc-actividades'),fecha_salida:g('sc-fecha-salida'),fecha_regreso:g('sc-fecha-regreso'),participantes:g('sc-participantes'),transporte:g('sc-transporte')};
  if(type==='pr') return{...base,programa:g('pr-programa'),actividad:g('pr-actividad'),justificacion:g('pr-justificacion'),tipo_recurso:g('pr-tipo'),monto:g('pr-monto'),proyecto:g('pr-proyecto'),fecha_req:g('pr-fecha')};
  if(type==='oe') return{...base,nombre_evento:g('oe-nombre'),fecha_evento:g('oe-fecha'),sede:g('oe-sede'),presupuesto:g('oe-presupuesto'),asistentes:g('oe-asistentes'),proyecto:g('oe-proyecto'),lgac:g('oe-lgac')};
}

async function submitForm(type) {
  if(!validate(type)) { showAlert(type,'error','Complete todos los campos obligatorios (*)'); return; }

  const btn = document.getElementById('btn-submit-'+type);
  btn.disabled = true;
  btn.textContent = '‚è≥ Registrando‚Ä¶';

  const folio  = assignFolio(type);
  const record = buildRecord(type, folio);

  // Sincronizar con Drive / Sheets
  const gasUrl = cfg.gasUrl || DEFAULT_GAS_URL;
  let driveUrl = '';
  if(gasUrl) {
    const result = await syncToDrive(record);
    if(result.ok) {
      driveUrl = result.driveUrl || '';
      record.driveUrl = driveUrl;
    }
  }

  data.push(record);
  saveData(data);
  updateAllCounters();
  updateFolioPreview(type);

  const d = new Date().toISOString().split('T')[0].replace(/-/g,'');
  const fname = `${TYPE_LABELS[type].replace(/ /g,'')}_${record.matricula}_${record.apellidos.split(' ')[0]}_${d}`;

  let msg = `‚úì Folio ${folio} registrado  -  ${fname}`;
  if(driveUrl) msg += `  -  <a href="${driveUrl}" target="_blank" style="color:var(--green)">Ver en Drive ‚Üó</a>`;
  else if(gasUrl) msg += '  -  ‚ö†Ô∏è Sin conexi√≥n a Drive (guardado localmente)';
  else msg += '  -  Guardado localmente (Drive no configurado)';

  document.getElementById(type+'-alert-msg').innerHTML = msg;
  const alertEl = document.getElementById(type+'-alert');
  alertEl.className = 'alert alert-success show';
  setTimeout(()=>alertEl.classList.remove('show'), 9000);

  btn.disabled = false;
  btn.textContent = '‚¨á Registrar + Guardar en Drive';
  document.querySelector('.content').scrollTo({top:0,behavior:'smooth'});
}

function showAlert(type, kind, msg) {
  const el=document.getElementById(type+'-alert');
  const m=document.getElementById(type+'-alert-msg');
  el.className=`alert alert-${kind} show`;
  m.textContent=msg;
  setTimeout(()=>el.classList.remove('show'),7000);
}

function resetForm(type) {
  document.querySelectorAll(`#form-${type} input,#form-${type} select,#form-${type} textarea`).forEach(el=>{el.value='';el.classList.remove('err');});
  const today=new Date().toISOString().split('T')[0];
  ['pg-fecha','sc-fecha-salida','sc-fecha-regreso','pr-fecha','oe-fecha'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=today;});
  const a=document.getElementById(type+'-alert'); if(a) a.classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TABLA MIS TR√ÅMITES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTable() {
  const q=((document.getElementById('q-search')||{}).value||'').toLowerCase();
  const tF=(document.getElementById('q-tipo')||{}).value||'';
  const sF=(document.getElementById('q-estado')||{}).value||'';
  let rows=[...data].reverse().filter(r=>{
    const matchQ=!q||JSON.stringify(r).toLowerCase().includes(q);
    const matchT=!tF||r.type===tF;
    const matchS=!sF||r.estado===sF;
    return matchQ&&matchT&&matchS;
  });
  const tbody=document.getElementById('table-body');
  const empty=document.getElementById('table-empty');
  tbody.innerHTML='';
  if(!rows.length){empty.style.display='block';document.getElementById('main-table').style.display='none';return;}
  empty.style.display='none';
  document.getElementById('main-table').style.display='table';
  const estadoMap={'Pendiente':'badge-pending','En revisi√≥n':'badge-review','Completado':'badge-done','Cancelado':'badge-canceled'};
  rows.forEach((r,i)=>{
    const ds=new Date(r.fecha).toLocaleDateString('es-MX',{day:'2-digit',month:'2-digit',year:'numeric'});
    const driveCell=r.driveUrl?`<a class="drive-link" href="${r.driveUrl}" target="_blank">üìÑ Drive</a>`:`<span style="color:var(--border);font-size:.72rem">-</span>`;
    tbody.innerHTML+=`<tr>
      <td><span style="font-family:'IBM Plex Mono',monospace;font-size:.78rem;color:var(--teal);font-weight:600">${r.folio}</span></td>
      <td><span style="font-size:.72rem">${TYPE_ICONS[r.type]} ${r.label}</span></td>
      <td>${r.apellidos}, ${r.nombres}</td>
      <td style="font-family:'IBM Plex Mono',monospace;font-size:.75rem">${r.matricula}</td>
      <td style="font-size:.75rem;color:var(--muted)">${ds}</td>
      <td><span class="badge ${estadoMap[r.estado]||'badge-new'}">${r.estado}</span></td>
      <td>${driveCell}</td>
      <td style="display:flex;gap:4px">
        <button class="btn btn-ghost btn-sm" onclick="changeStatus(${data.length-1-i})" title="Cambiar estado">‚úèÔ∏è</button>
        <button class="btn btn-ghost btn-sm" onclick="printRecord(${data.length-1-i})" title="Imprimir">üñ®</button>
        <button class="btn btn-ghost btn-sm" onclick="deleteRecord(${data.length-1-i})" title="Eliminar">üóë</button>
      </td>
    </tr>`;
  });
}

function changeStatus(idx) {
  const estados=['Pendiente','En revisi√≥n','Completado','Cancelado'];
  const curr=data[idx].estado;
  data[idx].estado=estados[(estados.indexOf(curr)+1)%estados.length];
  saveData(data);
  // Sync status change to sheets
  syncStatusUpdate(data[idx].folio, data[idx].estado);
  renderTable();
  updateAllCounters();
}

async function syncStatusUpdate(folio, estado) {
  const gasUrl=cfg.gasUrl||DEFAULT_GAS_URL;
  const secret=cfg.secret||DEFAULT_SECRET;
  if(!gasUrl) return;
  try {
    await fetch(gasUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'updateStatus',secret,folio,estado,requestedBy:currentUser?currentUser.email:''})});
  } catch{}
}

function deleteRecord(idx) {
  if(!confirm(`¬øEliminar ${data[idx].folio}?`)) return;
  data.splice(idx,1);
  saveData(data);
  renderTable();
  updateAllCounters();
}

function printRecord(idx) { printFormFromRecord(data[data.length-1-idx]||data[idx]); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAdminTable() {
  const q=((document.getElementById('adm-search')||{}).value||'').toLowerCase();
  const tF=((document.getElementById('adm-tipo')||{}).value)||'';
  const sF=((document.getElementById('adm-estado')||{}).value)||'';
  let rows=[...adminData].reverse().filter(r=>{
    const str=JSON.stringify(Object.values(r)).toLowerCase();
    const matchQ=!q||str.includes(q);
    const matchT=!tF||(r['Tipo']||'').includes(tF);
    const matchS=!sF||r['Estado']===sF;
    return matchQ&&matchT&&matchS;
  });
  const tbody=document.getElementById('admin-tbody');
  const empty=document.getElementById('admin-empty');
  tbody.innerHTML='';
  if(!rows.length){empty.style.display='block';document.getElementById('admin-table').style.display='none';return;}
  empty.style.display='none';
  document.getElementById('admin-table').style.display='table';
  const estadoMap={'Pendiente':'badge-pending','En revisi√≥n':'badge-review','Completado':'badge-done','Cancelado':'badge-canceled'};
  rows.forEach(r=>{
    const driveCell=r['URL Drive']?`<a class="drive-link" href="${r['URL Drive']}" target="_blank">üìÑ Abrir</a>`:'-';
    tbody.innerHTML+=`<tr>
      <td><span style="font-family:'IBM Plex Mono',monospace;font-size:.78rem;color:var(--teal);font-weight:600">${r['Folio']||''}</span></td>
      <td style="font-size:.78rem">${r['Tipo']||''}</td>
      <td>${r['Apellidos']||''}, ${r['Nombres']||''}</td>
      <td style="font-family:'IBM Plex Mono',monospace;font-size:.72rem">${r['Matr√≠cula']||''}</td>
      <td style="font-size:.75rem;color:var(--muted)">${r['Correo']||''}</td>
      <td style="font-size:.72rem;color:var(--muted)">${r['Fecha Registro']||''}</td>
      <td><span class="badge ${estadoMap[r['Estado']]||'badge-new'}">${r['Estado']||'-'}</span></td>
      <td>${driveCell}</td>
      <td><select style="font-size:.72rem;padding:3px 6px;border-radius:4px;border:1px solid var(--border)" onchange="adminChangeStatus('${r['Folio']}',this.value)">
        <option ${r['Estado']==='Pendiente'?'selected':''}>Pendiente</option>
        <option ${r['Estado']==='En revisi√≥n'?'selected':''}>En revisi√≥n</option>
        <option ${r['Estado']==='Completado'?'selected':''}>Completado</option>
        <option ${r['Estado']==='Cancelado'?'selected':''}>Cancelado</option>
      </select></td>
    </tr>`;
  });
}

function adminChangeStatus(folio, estado) {
  syncStatusUpdate(folio, estado);
  const idx=adminData.findIndex(r=>r['Folio']===folio);
  if(idx>-1) adminData[idx]['Estado']=estado;
  localStorage.setItem(ADMIN_CACHE_KEY, JSON.stringify(adminData));
  updateAdminStats();
}

function updateAdminStats(stats) {
  if(stats) {
    document.getElementById('adm-total').textContent = stats.total||0;
    document.getElementById('adm-pend').textContent  = stats.pendientes||0;
    document.getElementById('adm-done').textContent  = stats.completados||0;
    document.getElementById('adm-hoy').textContent   = stats.hoy||0;
  } else {
    // Compute from local adminData
    const today=new Date().toLocaleDateString('es-MX');
    document.getElementById('adm-total').textContent = adminData.length;
    document.getElementById('adm-pend').textContent  = adminData.filter(r=>r['Estado']==='Pendiente').length;
    document.getElementById('adm-done').textContent  = adminData.filter(r=>r['Estado']==='Completado').length;
    document.getElementById('adm-hoy').textContent   = adminData.filter(r=>(r['Fecha Registro']||'').includes(today.split('/')[0])).length;
  }
  document.getElementById('nb-cloud').textContent = adminData.length;
}

function renderAdminList(admins) {
  const el=document.getElementById('admins-list');
  if(!admins||!admins.length){ el.innerHTML='<span style="color:var(--muted);font-size:.78rem">Sin admins cargados</span>'; return; }
  el.innerHTML=admins.map(a=>`
    <div style="display:flex;align-items:center;gap:8px;background:var(--surf);border:1px solid var(--border);border-radius:6px;padding:6px 12px">
      <span style="font-size:.82rem;font-weight:600;color:var(--navy)">${a['Email']||''}</span>
      ${a['Nombre']?`<span style="font-size:.72rem;color:var(--muted)">${a['Nombre']}</span>`:''}
      <span class="tag-admin">ADMIN</span>
      <button class="btn btn-ghost btn-sm" style="margin-left:auto;font-size:.68rem;padding:2px 8px;color:var(--red)" onclick="removeAdmin('${a['Email']}')">‚úï</button>
    </div>`).join('');
}

async function addAdmin() {
  const email=document.getElementById('new-admin-email').value.trim();
  const nombre=document.getElementById('new-admin-nombre').value.trim();
  if(!email||!email.includes('@')){ showAdminMsg('error','Ingrese un email v√°lido'); return; }
  const gasUrl=cfg.gasUrl||DEFAULT_GAS_URL;
  const secret=cfg.secret||DEFAULT_SECRET;
  if(!gasUrl){ showAdminMsg('error','Configure el URL del servidor primero'); return; }
  try {
    const r=await fetch(gasUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'addAdmin',secret,email,nombre,requestedBy:currentUser.email})});
    const j=await r.json();
    if(j.ok){ showAdminMsg('success',`‚úì ${email} agregado como administrador`); document.getElementById('new-admin-email').value=''; document.getElementById('new-admin-nombre').value=''; refreshAdminData(true); }
    else showAdminMsg('error', j.error||'Error al agregar');
  } catch(e){ showAdminMsg('error','Error de conexi√≥n: '+e.message); }
}

async function removeAdmin(email) {
  if(!confirm(`¬øQuitar acceso admin a ${email}?`)) return;
  const gasUrl=cfg.gasUrl||DEFAULT_GAS_URL;
  const secret=cfg.secret||DEFAULT_SECRET;
  try {
    const r=await fetch(gasUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'removeAdmin',secret,email,requestedBy:currentUser.email})});
    const j=await r.json();
    if(j.ok){ showAdminMsg('success',`‚úì ${email} removido`); refreshAdminData(true); }
    else showAdminMsg('error',j.error||'Error al remover');
  } catch(e){ showAdminMsg('error',e.message); }
}

function showAdminMsg(kind, msg) {
  const el=document.getElementById('admin-msg');
  el.className=`alert alert-${kind} show`;
  el.innerHTML=`<span>${msg}</span>`;
  setTimeout(()=>el.classList.remove('show'),7000);
}

function exportAdminCSV() {
  if(!adminData.length){ alert('Sin datos admin'); return; }
  const headers=Object.keys(adminData[0]);
  const rows=[headers,...adminData.map(r=>headers.map(h=>r[h]||''))];
  const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'}));
  a.download=`CITRO_Admin_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
  const total=data.length,pend=data.filter(r=>r.estado==='Pendiente').length,done=data.filter(r=>r.estado==='Completado').length;
  const today_str=new Date().toISOString().split('T')[0];
  const todayCount=data.filter(r=>r.fecha.startsWith(today_str)).length;
  document.getElementById('st-total').textContent=total;
  document.getElementById('st-pend').textContent=pend;
  document.getElementById('st-done').textContent=done;
  document.getElementById('st-today').textContent=todayCount;
  document.getElementById('st-date-lbl').textContent=new Date().toLocaleDateString('es-MX',{weekday:'long',day:'numeric',month:'short'});
  const tl=document.getElementById('dash-timeline'),emp=document.getElementById('dash-empty');
  if(!data.length){emp.style.display='block';tl.innerHTML='';tl.appendChild(emp);return;}
  emp.style.display='none';
  const recent=[...data].reverse().slice(0,5);
  tl.innerHTML='<div class="timeline">'+recent.map(r=>{
    const time=new Date(r.fecha).toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'});
    const cls=r.estado==='Completado'?'done':r.driveUrl?'cloud':'new';
    const driveTag=r.driveUrl?`<a href="${r.driveUrl}" target="_blank" style="font-size:.68rem;color:var(--teal);margin-left:6px">üìÑ Drive</a>`:'';
    return `<div class="tl-item ${cls}"><div class="tl-time">${time}</div><div class="tl-text"><strong>${TYPE_ICONS[r.type]} ${r.label}</strong> - ${r.apellidos}, ${r.nombres}  -  <span style="font-family:'IBM Plex Mono',monospace;color:var(--teal);font-size:.72rem">${r.folio}</span>${driveTag}</div></div>`;
  }).join('')+'</div>';
  const types=['pg','sc','pr','oe'];
  const typeBars=document.getElementById('type-bars');
  if(!data.length){typeBars.innerHTML='<div style="text-align:center;padding:16px;color:var(--muted);font-size:.78rem">Sin datos</div>';return;}
  typeBars.innerHTML=types.map(t=>{
    const cnt=data.filter(r=>r.type===t).length;
    const pct=total?Math.round(cnt/total*100):0;
    return `<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;font-size:.72rem;margin-bottom:3px"><span>${TYPE_ICONS[t]} ${TYPE_LABELS[t]}</span><span style="font-family:'IBM Plex Mono',monospace;color:var(--muted)">${cnt}</span></div><div style="height:6px;background:var(--surf2);border-radius:3px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${TYPE_COLORS[t]};border-radius:3px;transition:width .6s ease"></div></div></div>`;
  }).join('');
  // Sync card
  const syncEl=document.getElementById('sync-detail');
  const gasUrl=cfg.gasUrl||DEFAULT_GAS_URL;
  if(gasUrl) syncEl.innerHTML=`<span style="color:var(--green)">‚óè Drive activo</span>  -  Los nuevos tr√°mites se guardan autom√°ticamente en Drive y en la hoja de seguimiento CITRO.`;
  else syncEl.innerHTML='<span style="color:var(--muted)">‚òÅÔ∏è Configure el URL del servidor en <strong>Configuraci√≥n</strong> para activar Drive.</span>';
}

function updateAllCounters() {
  document.getElementById('nb-total').textContent=data.length;
  ['pg','sc','pr','oe'].forEach(t=>{ document.getElementById('nb-'+t).textContent=data.filter(r=>r.type===t).length; });
  document.getElementById('sb-count').textContent=`${data.length} tr√°mite${data.length!==1?'s':''} local${data.length!==1?'es':''}`;
  renderDashboard();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveConfig() {
  const gasUrl=(document.getElementById('cfg-gas-url')||{}).value||'';
  const secret=(document.getElementById('cfg-secret')||{}).value||'';
  cfg.gasUrl=gasUrl; cfg.secret=secret;
  saveCfg(cfg);
  const testEl=document.getElementById('conn-test-result');
  testEl.innerHTML='<div class="sync-dot pending"></div> Probando‚Ä¶';
  if(gasUrl) {
    try {
      const email=currentUser?currentUser.email:'test@uv.mx';
      const r=await fetch(`${gasUrl}?action=stats&email=${encodeURIComponent(email)}&secret=${encodeURIComponent(secret)}`);
      const j=await r.json();
      if(j.ok||j.error==='No autorizado') { testEl.innerHTML='<div class="sync-dot ok"></div> <span style="color:var(--green)">Conexi√≥n exitosa ‚úì</span>'; isOnline=true; }
      else testEl.innerHTML=`<div class="sync-dot error"></div> <span style="color:var(--red)">Error: ${j.error}</span>`;
    } catch(e){ testEl.innerHTML=`<div class="sync-dot error"></div> <span style="color:var(--red)">Sin conexi√≥n: ${e.message}</span>`; }
  } else { testEl.innerHTML='<span style="color:var(--muted)">Sin URL configurado</span>'; }
}

function saveInstitConfig() {
  cfg.inst=(document.getElementById('cfg-inst')||{}).value||'';
  cfg.uni=(document.getElementById('cfg-uni')||{}).value||'';
  cfg.director=(document.getElementById('cfg-director')||{}).value||'';
  cfg.mail=(document.getElementById('cfg-mail')||{}).value||'';
  saveCfg(cfg);
  alert('Configuraci√≥n institucional guardada.');
}

function renderConfigStats() {
  const today_str=new Date().toISOString().split('T')[0];
  document.getElementById('config-stats').innerHTML=`Total: <strong>${data.length}</strong> &nbsp;|&nbsp; PG: <strong>${data.filter(r=>r.type==='pg').length}</strong> &nbsp;|&nbsp; SC: <strong>${data.filter(r=>r.type==='sc').length}</strong> &nbsp;|&nbsp; PR: <strong>${data.filter(r=>r.type==='pr').length}</strong> &nbsp;|&nbsp; OE: <strong>${data.filter(r=>r.type==='oe').length}</strong><br>Pendientes: <strong>${data.filter(r=>r.estado==='Pendiente').length}</strong> &nbsp;|&nbsp; Completados: <strong>${data.filter(r=>r.estado==='Completado').length}</strong><br>Hoy: <strong>${data.filter(r=>r.fecha.startsWith(today_str)).length}</strong> nuevos &nbsp;|&nbsp; Folios: PG:${folios.PG}  -  SC:${folios.SC}  -  PR:${folios.PR}  -  OE:${folios.OE}<br>Drive: <strong>${data.filter(r=>r.driveUrl).length}</strong> sincronizados`;
  if(cfg.gasUrl) document.getElementById('cfg-gas-url').value=cfg.gasUrl;
  if(cfg.secret) document.getElementById('cfg-secret').value=cfg.secret;
  if(cfg.inst)   document.getElementById('cfg-inst').value=cfg.inst;
  if(cfg.uni)    document.getElementById('cfg-uni').value=cfg.uni;
  if(cfg.director) document.getElementById('cfg-director').value=cfg.director;
  if(cfg.mail)   document.getElementById('cfg-mail').value=cfg.mail;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORT / IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV() {
  if(!data.length){ alert('Sin datos'); return; }
  const rows=[['Folio','Tipo','Apellidos','Nombres','Matr√≠cula','Correo','Fecha','Estado','Drive']];
  data.forEach(r=>rows.push([r.folio,r.label,r.apellidos,r.nombres,r.matricula,r.correo,r.fecha.split('T')[0],r.estado,r.driveUrl||'']));
  const csv=rows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'}));
  a.download=`CITRO_tramites_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
}

function exportJSON() {
  const blob=new Blob([JSON.stringify({tramites:data,folios},null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`CITRO_backup_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
}

function clearAll() {
  if(!confirm('¬øBorrar TODOS los datos locales? (Los datos en Drive/Sheets no se borrar√°n)')) return;
  data=[];folios={PG:0,SC:0,PR:0,OE:0};
  saveData(data);saveFolios(folios);
  updateAllCounters();
  alert('Datos locales borrados.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRINT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function printForm(type) {
  const r=buildRecord(type,'BORRADOR');
  r.type=type;
  printFormFromRecord(r);
}

function printFormFromRecord(r) {
  const today=new Date().toLocaleDateString('es-MX',{day:'numeric',month:'long',year:'numeric'});
  const folio=r.folio;
  const TYPE_COLORS_HEX={pg:'#5B2F8A',sc:'#1A7A4A',pr:'#B85C0A',oe:'#1B5FA8'};
  const color=TYPE_COLORS_HEX[r.type]||'#0A7A6E';

  const header=`<div style="text-align:center;border-bottom:2px solid #0D1F3C;padding-bottom:12px;margin-bottom:16px"><div style="font-size:9pt;text-transform:uppercase;letter-spacing:.1em;color:#5A6880">Centro de Investigaciones Tropicales</div><div style="font-size:16pt;font-weight:bold;color:#0D1F3C">UNIVERSIDAD VERACRUZANA</div><div style="font-size:9pt;color:#5A6880">${cfg.inst||''}  -  Xalapa, Veracruz  -  ${today}</div></div>`;
  const firma=`<div style="margin-top:48px;display:grid;grid-template-columns:1fr 1fr;gap:32px"><div style="text-align:center"><div style="border-top:1px solid #333;padding-top:6px;font-size:9pt">Firma del solicitante<br><span style="color:#5A6880">${r.apellidos}, ${r.nombres}  -  ${r.matricula}</span></div></div><div style="text-align:center"><div style="border-top:1px solid #333;padding-top:6px;font-size:9pt">Vo.Bo. Direcci√≥n CITRO${cfg.director?'<br><span style="color:#5A6880">'+cfg.director+'</span>':''}</div></div></div><div style="margin-top:16px;text-align:center;font-size:8pt;color:#9AA5B4;border-top:1px solid #eee;padding-top:8px">CITRO-Formularios v3.0  -  Folio <strong style="color:${color}">${folio}</strong></div>`;

  let body='';
  if(r.type==='pg') body=`<p><strong>Tipo:</strong> ${r.tipo||''}</p><p><strong>Urgencia:</strong> ${r.urgencia||''}</p><p><strong>Descripci√≥n:</strong></p><p>${r.descripcion||''}</p>${r.obs?`<p><strong>Observaciones:</strong> ${r.obs}</p>`:''}${r.adjuntos?`<p><strong>Adjuntos:</strong> ${r.adjuntos}</p>`:''}`;
  else if(r.type==='sc') body=`<p><strong>Lugar(es) [Lugares]:</strong></p><p>${r.lugares||''}</p><p><strong>Actividades [Actividades]:</strong></p><p>${r.actividades||''}</p><p><strong>Fecha [Fecha]:</strong> ${r.fecha_salida||''} al ${r.fecha_regreso||''}</p>${r.participantes?`<p><strong>Participantes:</strong> ${r.participantes}</p>`:''}${r.transporte?`<p><strong>Transporte:</strong> ${r.transporte}</p>`:''}`;
  else if(r.type==='pr') body=`<p><strong>Actividad [Actividad]:</strong> ${r.actividad||''}</p><p><strong>Justificaci√≥n [Justificaci√≥n]:</strong></p><p>${r.justificacion||''}</p><p><strong>Tipo de recurso:</strong> ${r.tipo_recurso||''}</p>${r.monto?`<p><strong>Monto:</strong> $${parseFloat(r.monto||0).toLocaleString('es-MX',{minimumFractionDigits:2})} MXN</p>`:''}${r.proyecto?`<p><strong>Proyecto:</strong> ${r.proyecto}</p>`:''}`;
  else if(r.type==='oe') body=`<p><strong>Evento [Evento]:</strong> ${r.nombre_evento||''}</p><p><strong>Fecha y sede [Datos]:</strong> ${r.fecha_evento||''}  -  ${r.sede||''}</p><p><strong>Presupuesto [Monto]:</strong> $${parseFloat(r.presupuesto||0).toLocaleString('es-MX',{minimumFractionDigits:2})} MXN</p><p><strong>Asistentes [N√∫mero]:</strong> ${r.asistentes||''}</p><p><strong>Proyecto [Proyecto]:</strong> ${r.proyecto||''}</p><p><strong>LGAC/PLADEA [Descripci√≥n]:</strong></p><p>${r.lgac||''}</p>`;

  const w=window.open('','_blank','width=794,height=1100');
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>CITRO - ${folio}</title><style>body{font-family:'Times New Roman',serif;font-size:12pt;line-height:1.65;margin:2cm;color:#111}p{margin-bottom:8px}@media print{body{margin:1.5cm}}</style></head><body>
    ${header}
    <div style="text-align:right;margin-bottom:16px"><span style="font-family:monospace;background:#f2f5fa;padding:4px 10px;border-radius:4px;font-size:10pt;color:${color}">Folio: ${folio}</span></div>
    <p><strong>Asunto:</strong> ${r.label}</p>
    <p>A quien corresponda:</p>
    <p>Yo, <strong>${r.grado?r.grado+' ':''}${r.apellidos}, ${r.nombres}</strong>, con matr√≠cula <strong>${r.matricula}</strong>${r.programa?', estudiante del programa de <strong>'+r.programa+'</strong>':''}, solicito respetuosamente:</p>
    ${body}
    <p style="margin-top:12px">Atentamente,<br><strong>${r.apellidos}, ${r.nombres}</strong></p>
    ${firma}
    </body></html>`);
  w.document.close();
  setTimeout(()=>w.print(),400);
}

function toggleUserMenu() {}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init() {
  const today=new Date().toISOString().split('T')[0];
  ['pg-fecha','sc-fecha-salida','sc-fecha-regreso','pr-fecha','oe-fecha'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=today;});
  document.querySelectorAll('input,select,textarea').forEach(el=>{el.addEventListener('input',()=>el.classList.remove('err'));el.addEventListener('change',()=>el.classList.remove('err'));});
  updateAllCounters();
  renderConfigStats();
  // Load config into inputs
  if(cfg.gasUrl) { const el=document.getElementById('cfg-gas-url'); if(el) el.value=cfg.gasUrl; }
  if(cfg.secret) { const el=document.getElementById('cfg-secret'); if(el) el.value=cfg.secret; }
  // Init Google Sign-In
  initGoogleSignIn();
}
init();
</script>
</body>
</html>
